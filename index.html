<!DOCTYPE html>
<html>
    <head>
        <link href="./style.css" rel="stylesheet" />
        <script src="./bf.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const inputEl = document.getElementById('txtInput')
                const getInput = () => new Promise(function(resolve, reject) {
                    if (!inputEl.value) {
                        inputEl.classList.add('input-needed')
                        inputEl.focus()
                        inputEl.addEventListener('onkeypress', function(e) {
                            if (!resolve) return
                            e.preventDefault()
                            resolve(e.keyCode === 13 ? '' : String.fromCharCode(e.keyCode))
                            inputEl.classList.remove('input-needed')
                        })
                    } else {
                        const retVal = inputEl.value[0]
                        inputEl.value = inputEl.value.substring(1)
                        resolve(retVal)
                    }
                })

                let output = ''

                const onOutput = ch => {
                    if (!ch) return;
                    if (!ch.replace(/\0/g,'')) return
                    output += ch;
                    updateOutputUI()
                }

                const updateOutputUI = () => {
                    document.getElementById('lblResult').innerHTML = 
                        output === '' ? 'No Result' : output
                    document.getElementById('lblResultHex').innerHTML =
                        output === '' ? 'x00' : strToHex(output)
                }

                document.getElementById('btnRemoveUnused').addEventListener('click', function() {
                    const programTxt = document.getElementById('txtProgram').value
                    const removed = removeUnusedCharacters(programTxt)
                    document.getElementById('txtProgram').value = removed
                })

                document.getElementById('btnCompile').addEventListener('click', async function() {
                    const programTxt = document.getElementById('txtProgram').value
                    output = ''
                    await compile(programTxt, getInput, onOutput)
                })
                
                const strToHex = str => Array.from(str)
                    .map(ch => Number(ch.charCodeAt(0)))
                    .map(code => `x${code.toString(16).padStart(2,'0')}`)
                    .join(' ')
            })
        </script>
    </head>
    <body>
        <label id='myLbl' class='grid-title'>Brainfuck compiler V0.0.0.0002</label>
        <a href="https://github.com/dipique/bf-js">GitHib</a>
        <div class='program-text'>
            <textarea id='txtProgram' class="code-text"></textarea>
            <button id='btnRemoveUnused'>Remove Unused Characters</button>
            <button id='btnCompile'>Compile</button>
        </div>
        <div>
            <label>Input is consumed from here, starting at the beginning</label>
            <input id='txtInput' type='text' placeholder="Has to be entered up front, for now" />
        </div>
        <div class="result-section">
            <label>Output</label>
            <label id='lblResult' class="code-text code-result"></label>
            <label id='lblResultHex' class="code-text code-result" title="Hex representation of the results (to help with invisible characters)"></label>
        </div>        
    </body>
</html>